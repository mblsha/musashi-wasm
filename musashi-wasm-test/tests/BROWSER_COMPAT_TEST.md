# Browser Compatibility Test

This test demonstrates a critical issue with musashi-wasm that prevents it from working in browser environments.

## The Problem

The current build of musashi-wasm (as of v0.1.4) has `ENVIRONMENT_IS_NODE` hardcoded to `true` in the generated `musashi-loader.mjs` file. This causes the module to always try to import Node.js-specific modules like `'module'` and `'fs'`, which don't exist in browsers.

## Running the Test

```bash
cd musashi-wasm-test
npm install
npm test browser_compat
```

## What the Test Shows

1. **Environment Detection**: Verifies the test can detect Node.js vs browser environments
2. **Node.js Loading**: Shows the module loads successfully in Node.js (if built)
3. **Browser Issues**: Documents the exact error that would occur in browsers
4. **Required Fix**: Specifies what needs to change in the build process

## The Error in Browsers

When loaded in a browser, users will see:
```
TypeError: Failed to resolve module specifier 'module'
```
or
```
TypeError: createRequire is not a function
```

## The Root Cause

In `musashi-loader.mjs` (generated by Emscripten):
```javascript
var ENVIRONMENT_IS_NODE = true;  // <-- Hardcoded!

if (ENVIRONMENT_IS_NODE) {
  const { createRequire } = await import('module');  // <-- Fails in browser!
  var require = createRequire(import.meta.url);
}
```

## The Fix

The build process needs to be updated to use proper environment detection:

### Option 1: Update Emscripten Flags
Add these flags to the build:
```bash
-s ENVIRONMENT='web,webview,worker,node'
-s SINGLE_FILE=0
-s MODULARIZE=1
-s EXPORT_ES6=1
```

### Option 2: Post-Process the Generated Code
Replace the hardcoded `ENVIRONMENT_IS_NODE = true` with:
```javascript
var ENVIRONMENT_IS_NODE = (
  typeof process == 'object' && 
  typeof process.versions == 'object' && 
  typeof process.versions.node == 'string'
);
```

## Workarounds

Until this is fixed upstream, users need to:

1. **Use separate builds** for Node.js and browsers
2. **Manually patch** the loader after generation
3. **Use a bundler** that can polyfill or replace the Node.js imports
4. **Load via script tag** instead of ES modules (if a UMD build is available)

## Testing Browser Compatibility

To test if a fix works:

1. Build the WASM module
2. Create a simple HTML file:
```html
<!DOCTYPE html>
<html>
<head>
  <script type="module">
    import createModule from './musashi.out.mjs';
    createModule().then(Module => {
      console.log('Success! Module loaded in browser');
      console.log('Available functions:', Object.keys(Module).filter(k => k.startsWith('_')));
    }).catch(error => {
      console.error('Failed to load:', error);
    });
  </script>
</head>
<body>
  <h1>musashi-wasm Browser Test</h1>
  <p>Check console for results</p>
</body>
</html>
```

3. Serve the HTML and WASM files with a local server
4. Open in browser and check console

## Impact

This issue prevents musashi-wasm from being used in:
- Web applications
- Browser-based emulators
- WebAssembly demos
- Client-side development tools

## References

- [Emscripten ENVIRONMENT setting](https://emscripten.org/docs/tools_reference/settings_reference.html#environment)
- [ES6 Module Support](https://emscripten.org/docs/api_reference/module.html#es6-modules)